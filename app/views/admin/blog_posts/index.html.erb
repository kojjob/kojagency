<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Manage Blog Posts</h1>
    <%= link_to 'New Post', new_admin_blog_post_path, class: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700' %>
  </div>

  <div class="mb-6">
    <%= form_with url: admin_blog_posts_path, method: :get, class: 'flex gap-4' do |f| %>
      <%= f.text_field :q, placeholder: 'Search posts...', value: params[:q], class: 'px-4 py-2 border rounded-lg flex-grow' %>

      <%= f.select :status,
          options_for_select([
            ['All Status', ''],
            ['Draft', 'draft'],
            ['Published', 'published'],
            ['Archived', 'archived']
          ], params[:status]),
          {},
          class: 'px-4 py-2 border rounded-lg' %>

      <%= f.submit 'Filter', class: 'px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700' %>
    <% end %>
  </div>

  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Published</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @posts.each do |post| %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <%= link_to post.title, admin_blog_post_path(post), class: 'text-blue-600 hover:text-blue-900' %>
              <% if post.featured? %>
                <span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Featured</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap"><%= post.author&.name %></td>
            <td class="px-6 py-4 whitespace-nowrap"><%= post.category&.name %></td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                <%= post.published? ? 'bg-green-100 text-green-800' :
                    post.draft? ? 'bg-yellow-100 text-yellow-800' :
                    'bg-gray-100 text-gray-800' %>">
                <%= post.status.capitalize %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= post.published_at&.strftime("%b %d, %Y") %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex gap-2">
                <% if defined?(admin_signed_in?) && admin_signed_in? %>
                  <%# Admins can access all actions %>
                  <%= link_to 'Edit', edit_admin_blog_post_path(post), class: 'text-indigo-600 hover:text-indigo-900' %>
                  <%= link_to 'Preview', preview_admin_blog_post_path(post), class: 'text-gray-600 hover:text-gray-900', target: '_blank' %>

                  <% if post.draft? %>
                    <%= button_to 'Publish', publish_admin_blog_post_path(post), method: :post, class: 'text-green-600 hover:text-green-900' %>
                  <% elsif post.published? %>
                    <%= button_to 'Archive', archive_admin_blog_post_path(post), method: :post, class: 'text-yellow-600 hover:text-yellow-900' %>
                  <% end %>

                  <%= button_to 'Delete', admin_blog_post_path(post), method: :delete,
                      data: { confirm: 'Are you sure?' },
                      class: 'text-red-600 hover:text-red-900' %>
                <% elsif defined?(current_blog_author) && current_blog_author && post.author == current_blog_author %>
                  <%# Blog authors can only edit/delete their own posts %>
                  <%= link_to 'Edit', edit_admin_blog_post_path(post), class: 'text-indigo-600 hover:text-indigo-900' %>
                  <%= link_to 'Preview', preview_admin_blog_post_path(post), class: 'text-gray-600 hover:text-gray-900', target: '_blank' %>

                  <% if post.draft? %>
                    <%= button_to 'Publish', publish_admin_blog_post_path(post), method: :post, class: 'text-green-600 hover:text-green-900' %>
                  <% elsif post.published? %>
                    <%= button_to 'Archive', archive_admin_blog_post_path(post), method: :post, class: 'text-yellow-600 hover:text-yellow-900' %>
                  <% end %>

                  <%= button_to 'Delete', admin_blog_post_path(post), method: :delete,
                      data: { confirm: 'Are you sure?' },
                      class: 'text-red-600 hover:text-red-900' %>
                <% else %>
                  <%# Other users can only view %>
                  <%= link_to 'View', admin_blog_post_path(post), class: 'text-gray-600 hover:text-gray-900' %>
                  <%= link_to 'Preview', preview_admin_blog_post_path(post), class: 'text-gray-600 hover:text-gray-900', target: '_blank' %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% if @posts.empty? %>
    <div class="text-center py-8">
      <p class="text-gray-500 mb-4">No blog posts found.</p>
      <%= link_to 'Create your first post', new_admin_blog_post_path, class: 'text-blue-600 hover:text-blue-900' %>
    </div>
  <% end %>

  <div class="mt-6">
    <%= paginate @posts %>
  </div>
</div>